#include <wiringPi.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>

#define MAXTIMINGS 85
#define MAX_TOLERANCE 25
#define DHTPIN 7

int dht11_dat[5] = { 0, 0, 0, 0, 0 };

uint8_t readu8(){
	uint8_t ret = 0;
	for (uint8_t i = 0; i < 8; i++) {
		ret <<= 1;
		delayMicroseconds(57);
		if (digitalRead(DHTPIN) == HIGH) {
			ret |= 1;
			delayMicroseconds(43);
		}
		uint8_t counter = 0;
		while (digitalRead(DHTPIN) == LOW) delayMicroseconds(1);
	}
	return ret;
}

void read_dht11_dat() {
	dht11_dat[0] = dht11_dat[1] = dht11_dat[2] = dht11_dat[3] = dht11_dat[4] = 0;
	pinMode(DHTPIN, OUTPUT);
	digitalWrite(DHTPIN, LOW);
	delay(20);
	digitalWrite(DHTPIN, HIGH);
	delayMicroseconds(40);
	pinMode(DHTPIN, INPUT);

	uint8_t counter = 0;
	while (digitalRead(DHTPIN) == LOW && ++counter < 90) delayMicroseconds(1);
	counter = 0;
	while (digitalRead(DHTPIN) == HIGH && ++counter < 90) delayMicroseconds(1);

	for (uint8_t i = 0; i < 5; i++) dht11_dat[i] = readu8();

	if ( dht11_dat[4] == ((dht11_dat[0] + dht11_dat[1] + dht11_dat[2] + dht11_dat[3]) & 0x7F)) {
		FILE *f = fopen("/tmp/ramfss/temperature", "w");
		fprintf(f, "%d.%d %d.%d", dht11_dat[0], dht11_dat[1], dht11_dat[2], dht11_dat[3]);
		fclose(f);
	}else  {
		//printf( "Data not good, skip\n" );
		//printf( "H = %d.%d; T1 = %d.%d; ? = %d vs %d\n", dht11_dat[0], dht11_dat[1], dht11_dat[2], dht11_dat[3], dht11_dat[4], (dht11_dat[0] + dht11_dat[1] + dht11_dat[2] + dht11_dat[3])&0x7F);
	}
}

int main( void ) {
	if ( wiringPiSetup() == -1 ) exit(1);
	while (1) {
		read_dht11_dat();
		delay(50);
	}
	return 0;
}

