#include <wiringPi.h>
#include <ncurses.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>

#define PIN 0
#define RESOLUTION 25

#define PARRAY(arr, len) for (uint16_t __i = 0; __i < len; __i++) printw("%d", arr[__i])

uint8_t _buffer1[1024*4];
uint8_t _buffer2[1024*4];

uint8_t *arr = _buffer1;
uint8_t *arr_bak = _buffer2;
uint16_t len = 0;
uint16_t len_bak = -1;
uint8_t in;


void colored_print() {
  uint8_t attr_color;
  if (len != len_bak) { PARRAY(arr, len); goto ret; }
  for (uint16_t i = 0; i < len; i++) {
    if (arr[i] == arr_bak[i]) { printw("%d", arr[i]); continue; }
    uint8_t color = arr[i] > arr_bak[i];
    uint32_t mask = (2 == (color? arr[i]-arr_bak[i]: arr_bak[i]-arr[i]) ? A_BOLD: 0) | COLOR_PAIR(color+1);
    attron(mask);
    printw("%d", arr[i]);
    attroff(mask);
  }
ret:
  printw("\n");
  refresh();
  len_bak = len; len = 0;
  { uint8_t *temp = arr; arr = arr_bak; arr_bak = temp; }
}

void read_dht11_dat() {
  // if input has not changed, skip this roll
  if (in == digitalRead(PIN)) {
    delayMicroseconds(RESOLUTION);
    return;
  }
  refresh();

  // start printing the bits now
  for (uint8_t count = 0; count < 0xFF; count++) {
    // if (in) printf("-"); // "â€¾"
    // else printf("_");
    delayMicroseconds(RESOLUTION);
    if (in != digitalRead(PIN)) {
      arr[len++] = count;
      count = 0;
      in = !in;
    }
  }

  // filter the high frquency output
  uint16_t eb = 0;
  for (uint16_t i = 0; i < len; i++) {
    if (arr[i] < 3) { eb++; continue; }
    arr[i-eb] = arr[i];
  }
  len -= eb;
  for (uint16_t i = 0; i < len; i++) {
    switch (arr[i]) {
      case 15 ...  25: arr[i] = 0; break;
      case 39 ...  49: arr[i] = 1; break;
      case 95 ... 105: arr[i] = 2; break;
    }
  }
  colored_print();
}


int main( void ) {
  setbuf(stdout, NULL);
  printf( "Ir Sensor\n" );
  // Initialize ncurses
  initscr();
  start_color();
  // raw();
  noecho();

  // Enable color mode
  if (has_colors() == FALSE) {
    endwin();
    printf("Your terminal does not support color\n");
    return 1;
  }

  // Define color pairs
  init_pair(1, COLOR_RED, COLOR_BLACK);
  init_pair(2, COLOR_GREEN, COLOR_BLACK);

  // setup gpio
  if ( wiringPiSetup() == -1 ) exit( 1 );
  pinMode(PIN, INPUT);
  // why delay? just in case!!
  delayMicroseconds(1);
  // need initial reference
  in = digitalRead(PIN);

  for (;;) read_dht11_dat();

  endwin();
  return 0;
}

